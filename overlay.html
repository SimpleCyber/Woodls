<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: transparent;
        user-select: none;
        -webkit-app-region: drag; /* draggable if needed, but usually static */
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <!-- Pill Container -->
    <div
      class="bg-[#181818] rounded-full px-2 flex items-center justify-between gap-1 shadow-2xl transition-all duration-200 h-full w-full border border-white/10"
      id="pill"
    >
      <!-- Cancel Button (X) - Left Side -->
      <div
        id="cancel-btn"
        class="hidden h-7 w-7 flex items-center justify-center rounded-full bg-white/10 hover:bg-red-500/80 text-white transition-all cursor-pointer flex-shrink-0 shadow-sm"
        style="-webkit-app-region: no-drag"
        title="Cancel Transcription"
      >
        <i class="fa-solid fa-xmark text-xs"></i>
      </div>

      <!-- Center Content: Waveform + Spinner + AI -->
      <div class="flex-1 flex items-center justify-center relative">
        <!-- Waveform Bars - Voice Responsive -->
        <div id="waveform" class="flex items-center gap-[3px] h-full">
          <div
            class="bar w-[3px] rounded-full h-2"
            style="
              background: linear-gradient(
                to top,
                #fff 0%,
                rgba(255, 255, 255, 0.8) 100%
              );
              transition:
                height 50ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 50ms ease-out;
            "
          ></div>
          <div
            class="bar w-[3px] rounded-full h-3"
            style="
              background: linear-gradient(
                to top,
                #fff 0%,
                rgba(255, 255, 255, 0.85) 100%
              );
              transition:
                height 50ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 50ms ease-out;
            "
          ></div>
          <div
            class="bar w-[3px] rounded-full h-5"
            style="
              background: linear-gradient(
                to top,
                #fff 0%,
                rgba(255, 255, 255, 0.9) 100%
              );
              transition:
                height 50ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 50ms ease-out;
            "
          ></div>
          <div
            class="bar w-[3px] rounded-full h-3"
            style="
              background: linear-gradient(
                to top,
                #fff 0%,
                rgba(255, 255, 255, 0.85) 100%
              );
              transition:
                height 50ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 50ms ease-out;
            "
          ></div>
          <div
            class="bar w-[3px] rounded-full h-2"
            style="
              background: linear-gradient(
                to top,
                #fff 0%,
                rgba(255, 255, 255, 0.8) 100%
              );
              transition:
                height 50ms cubic-bezier(0.4, 0, 0.2, 1),
                transform 50ms ease-out;
            "
          ></div>
        </div>

        <!-- Spinner (Hidden by default) -->
        <div id="spinner" class="hidden absolute">
          <i
            class="fa-solid fa-circle-notch text-white/50 text-sm animate-spin"
          ></i>
        </div>

        <!-- AI Status Icon (ðŸ¤–) -->
        <div id="ai-icon" class="hidden absolute right-2">
          <span class="text-[10px]">ðŸ¤–</span>
        </div>
      </div>

      <!-- Confirm Button (Tick) - Right Side -->
      <div
        id="confirm-btn"
        class="hidden h-7 w-7 flex items-center justify-center rounded-full bg-white hover:bg-green-50 text-black transition-all cursor-pointer shadow-lg flex-shrink-0"
        style="-webkit-app-region: no-drag"
        title="Finish and Transcribe"
      >
        <i class="fa-solid fa-check text-xs"></i>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");
      const bars = document.querySelectorAll(".bar");
      const pill = document.getElementById("pill");
      const waveform = document.getElementById("waveform");
      const spinner = document.getElementById("spinner");

      // Track last update time for idle animation
      let lastMicUpdate = 0;
      let isRecording = false;
      let animationFrame = null;

      // Wave-like center emphasis pattern
      const centerWeight = [0.7, 0.9, 1.0, 0.9, 0.7];

      // Update bars with given volume values
      function updateBars(volumes) {
        bars.forEach((bar, i) => {
          const v = Math.max(volumes[i] || 0.08, 0.08);
          const weighted = v * centerWeight[i];
          // Height range: 4px (min) to 32px (max)
          const h = 4 + weighted * 28;
          bar.style.height = h + "px";
          // Subtle scale for lively feel
          const scale = 1 + weighted * 0.15;
          bar.style.transform = `scaleY(${scale})`;
        });
      }

      // Idle breathing animation when no mic data
      function idleAnimation() {
        if (!isRecording) return;

        const now = Date.now();
        const timeSinceUpdate = now - lastMicUpdate;

        // If no mic data for 100ms, show idle animation
        if (timeSinceUpdate > 100) {
          const t = now / 1000;
          const idleVolumes =
            bars.length === 5
              ? [
                  0.15 + 0.1 * Math.sin(t * 3 + 0),
                  0.2 + 0.15 * Math.sin(t * 3.5 + 0.5),
                  0.25 + 0.2 * Math.sin(t * 4 + 1),
                  0.2 + 0.15 * Math.sin(t * 3.5 + 1.5),
                  0.15 + 0.1 * Math.sin(t * 3 + 2),
                ]
              : [0.2, 0.25, 0.3, 0.25, 0.2];

          updateBars(idleVolumes);
        }

        animationFrame = requestAnimationFrame(idleAnimation);
      }

      // Start idle animation when overlay shows
      function startIdleAnimation() {
        isRecording = true;
        lastMicUpdate = 0;
        if (!animationFrame) {
          idleAnimation();
        }
      }

      // Stop animation
      function stopIdleAnimation() {
        isRecording = false;
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }
      }

      // Listen for mic volume data
      ipcRenderer.on("mic-volume", (event, volumes) => {
        lastMicUpdate = Date.now();

        if (Array.isArray(volumes)) {
          updateBars(volumes);
        } else {
          // Single value fallback
          const v = Math.max(volumes, 0.1);
          const singleVolumes = centerWeight.map((w, i) => {
            const jitter = 0.9 + Math.random() * 0.2;
            return v * w * jitter;
          });
          updateBars(singleVolumes);
        }
      });

      // Start animation when overlay becomes visible
      // The overlay is shown via showInactive(), detect visibility
      const observer = new MutationObserver(() => {
        if (
          document.visibilityState === "visible" ||
          !waveform.classList.contains("hidden")
        ) {
          startIdleAnimation();
        }
      });

      // Auto-start animation on load (overlay is shown when recording starts)
      startIdleAnimation();

      // Processing states
      ipcRenderer.on("processing-start", () => {
        waveform.classList.add("hidden");
        spinner.classList.remove("hidden");
        // Hide all control buttons during processing as requested
        document.getElementById("cancel-btn").classList.add("hidden");
        document.getElementById("confirm-btn").classList.add("hidden");
        // Disable mouse events so users can't click hidden buttons during generation
        ipcRenderer.send("set-overlay-clickable", false);
      });

      ipcRenderer.on("processing-end", () => {
        spinner.classList.add("hidden");
        waveform.classList.remove("hidden");
        // Final close is handled by renderer calling hideOverlay or similar
        ipcRenderer.send("hide-overlay");
      });

      ipcRenderer.on("set-ai-status", (event, enabled) => {
        const aiIcon = document.getElementById("ai-icon");
        if (enabled) {
          aiIcon.classList.remove("hidden");
        } else {
          aiIcon.classList.add("hidden");
        }
      });

      // New combined control listener
      ipcRenderer.on("set-controls", (event, { showCancel, showConfirm }) => {
        const cancelBtn = document.getElementById("cancel-btn");
        const confirmBtn = document.getElementById("confirm-btn");

        if (showCancel) cancelBtn.classList.remove("hidden");
        else cancelBtn.classList.add("hidden");

        if (showConfirm) confirmBtn.classList.remove("hidden");
        else confirmBtn.classList.add("hidden");
      });

      // Legacy listener - can be removed or kept as fallback
      ipcRenderer.on("show-cancel", (event, show) => {
        const cancelBtn = document.getElementById("cancel-btn");
        const confirmBtn = document.getElementById("confirm-btn");
        if (show) {
          cancelBtn.classList.remove("hidden");
          confirmBtn.classList.remove("hidden");
        } else {
          cancelBtn.classList.add("hidden");
          confirmBtn.classList.add("hidden");
        }
      });

      document.getElementById("cancel-btn").onclick = () => {
        ipcRenderer.send("cancel-recording");
      };

      document.getElementById("confirm-btn").onclick = () => {
        ipcRenderer.send("confirm-recording");
      };
    </script>
  </body>
</html>
